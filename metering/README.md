В этой директории находятся фейковый сервер и примеры клиентов для работы с ним, написанные на Go и Python.

## Запуск сервера

```bash
docker-compose up --build
```

Для корректной работы фейкового сервера необходимо в `/etc/hosts` добавить запись `api.yc.local`:

```
127.0.0.1 api.yc.local
::1 api.yc.local
```

Для конфигурации сервера используются переменные окружения:

`PORT` — порт, на котором будет запущен сервер (по умолчанию 8080).

`BINDINGS` — список привязок SKU к продукту. В данном примере SKU `sku` привязан к продукту `product`. Пример:
```json
[
  {
    "sku_id": "sku",
    "product_id": "product"
  }
]
```

`MODE` — режим работы сервера. Возможные значения:
- `always` — всегда возвращать `OK`. По умолчанию.
- `never` — всегда возвращать ошибку авторизации.
- `dryrun` — режим для воспроизведения поведения, при котором запрос с `validate_only: true` возвращается успешно, а к
  моменту,
  когда нужно отправить настоящую метрику, аккаунт пользователя или сервисный аккаунт, от имени которого осуществляется
  отправка, находятся в невалидном состоянии.

`ENDPOINT` — адрес, на котором будет доступен сервер. По умолчанию `api.yc.local`.

## Отправка метрики

Пример отправки метрики фейковому серверу с помощью `grpcurl`:

```bash
grpcurl -d @ \
 -cacert ./fake/x509/ca.crt \
 api.yc.local:8080 yandex.cloud.marketplace.metering.v1.ImageProductUsageService/Write <<EOM
{
  "product_id": "product",
  "validate_only": true,
  "usage_records": [
    {
      "uuid": "`uuidgen`",
      "sku_id": "sku",
      "quantity": 1,
      "timestamp": "`date -u "+%Y-%m-%dT%H:%M:%SZ"`"
    }
  ]
}
EOM
```

Пример ответа:

```json
{
  "accepted": [
    {
      "uuid": "7F086F17-9E8D-4DC1-A92B-47FC7E76CDA3"
    }
  ]
}
```

## Подготовка к запуску примеров

Чтобы подготовить окружение для запуска примера, выполните следующие команды:

```bash
yc iam service-account create --name metering
SA_ID=$(yc iam service-account get --name metering --format json | jq -r .id)
FOLDER_ID=$(yc config get folder-id)
yc resource-manager folder add-access-binding --role marketplace.meteringAgent --subject serviceAccount:$SA_ID --id $FOLDER_ID
yc iam key create --service-account-id $SA_ID --output key.json --description "Key for metering service account"
```

Несмотря на то, что фейковый сервер не проверяет подлинность ключа и не выпускает токен, ключ все равно понадобится,
чтобы максимально приблизить пример к реальной работе с сервисом и легко переключаться между реальным и
фейковым сервером.

## Описание примеров

В демо приложении реализована отправка метрики с заданными параметрами `product_id`, `sku_id`, `quantity` и `timestamp`.
Для этого в примере используется сервисный аккаунт, который создается на предыдущем шаге.
Сначала в коде приложения инициализируется SDK и создается клиент сервиса метрики.
Затем отправляется метрика с заданными параметрами и дополнительно выставляется флаг `validate_only`, который позволяет
проверить корректность отправляемых данных без фактического списания средств со счета платежного аккаунта, связанного
с облаком.

Следующим шагом идет выполнение некоторого кода, имитирующего полезную работу приложения. Далее отправляется метрика с
теми же параметрами, что и в первый раз, но уже без флага `validate_only`. В случае успешной отправки метрики сервер
вернет ответ с UUID отправленной метрики.


## Запуск примера на Python

Для подготовки окружения выполните следующие команды:

```bash
./demo/init.sh
```

Для запуска примера выполните следующую команду:

```bash
python ./demo/python/main.py --product-id product --sku-id sku --quantity 1 --fake --service-account-key ./key.json
```

## Запуск примера на Go

Для запуска примера выполните следующую команду:

```bash
go run ./demo/go/main.go --product-id product --sku-id sku --quantity 1 --fake --service-account-key ./key.json
```